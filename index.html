<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MBPS Rehab Estimator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest + theme color -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10b981" />

  <!-- Icons (put PNGs in /icons) -->
  <link rel="apple-touch-icon" sizes="192x192" href="icons/mbps-rehab-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/mbps-rehab-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/mbps-rehab-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/mbps-rehab-512.png">

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">MBPS Rehab Estimator</h1>
        <p class="text-sm text-slate-400">
          Build your own local material &amp; labor cost database for rehab estimates.
        </p>
      </div>
      <span class="inline-flex items-center rounded-full border border-emerald-500/60 px-3 py-1 text-xs font-semibold text-emerald-300 bg-emerald-500/10">
        Local Only Â· Stored in this browser
      </span>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Material Library Builder -->
      <section class="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Material &amp; Labor Library</h2>
          <button id="reset-library"
                  class="text-xs px-3 py-1 rounded-full border border-red-500/70 text-red-300 hover:bg-red-500/10">
            Reset to MBPS Defaults
          </button>
        </div>

        <!-- Add / Edit Form -->
        <div class="bg-slate-950/80 border border-slate-800 rounded-2xl p-3 space-y-3">
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <div class="col-span-2">
              <label class="block text-xs font-semibold text-slate-400 mb-1">Material Name</label>
              <input id="mat-name" type="text" placeholder="LVP Flooring"
                     class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1">Category</label>
              <input id="mat-category" type="text" placeholder="Flooring / Kitchen / Bath"
                     class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1">Unit</label>
              <select id="mat-unit"
                      class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
                <option value="sqft">sqft</option>
                <option value="each">each</option>
                <option value="lf">linear ft</option>
                <option value="room">per room</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1">Material $ / unit</label>
              <input id="mat-cost-material" type="number" step="0.01" inputmode="decimal" placeholder="2.25"
                     class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1">Labor $ / unit</label>
              <input id="mat-cost-labor" type="number" step="0.01" inputmode="decimal" placeholder="2.00"
                     class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1">Active?</label>
              <select id="mat-active"
                      class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
                <option value="true" selected>Yes</option>
                <option value="false">No</option>
              </select>
            </div>
          </div>

          <div class="flex justify-end gap-2">
            <button id="clear-form"
                    class="text-xs px-3 py-1 rounded-full border border-slate-700 bg-slate-900/80 hover:bg-slate-800/90">
              Clear
            </button>
            <button id="save-material"
                    class="text-xs px-4 py-1.5 rounded-full bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400">
              Add to Library
            </button>
          </div>
          <input type="hidden" id="edit-id" value="" />
        </div>

        <!-- Library List -->
        <div class="space-y-2 max-h-80 overflow-y-auto pr-1" id="library-list">
          <!-- material cards injected here -->
        </div>
      </section>

      <!-- Calculator & Import/Export -->
      <section class="space-y-4">
        <!-- Simple Calculator Using Library -->
        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Quick Line-Item Estimator</h2>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
            <div class="md:col-span-2">
              <label class="block text-xs font-semibold text-slate-400 mb-1">Select Material</label>
              <select id="calc-material"
                      class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
                <!-- options injected -->
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1">Quantity</label>
              <input id="calc-qty" type="number" step="0.01" inputmode="decimal" placeholder="1000"
                     class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
            </div>
            <div>
              <button id="add-line"
                      class="w-full text-xs px-3 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400">
                + Add Line
              </button>
            </div>
          </div>

          <div class="overflow-x-auto mt-3">
            <table class="min-w-full text-xs border-separate border-spacing-y-1">
              <thead class="text-[0.7rem] uppercase text-slate-400">
                <tr>
                  <th class="text-left px-2 py-1">Material</th>
                  <th class="text-right px-2 py-1">Qty</th>
                  <th class="text-right px-2 py-1">Mat $</th>
                  <th class="text-right px-2 py-1">Labor $</th>
                  <th class="text-right px-2 py-1">Line Total</th>
                  <th class="px-2 py-1"></th>
                </tr>
              </thead>
              <tbody id="calc-body">
                <!-- lines injected -->
              </tbody>
            </table>
          </div>

          <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-800 text-xs">
            <div class="text-slate-400">
              Total Material: <span id="total-mat" class="font-semibold text-slate-100">$0</span><br>
              Total Labor: <span id="total-labor" class="font-semibold text-slate-100">$0</span>
            </div>
            <div class="text-right">
              <div class="text-[0.75rem] uppercase text-slate-400">Grand Total</div>
              <div id="grand-total" class="text-lg font-bold text-emerald-300">$0</div>
            </div>
          </div>
        </div>

        <!-- Import / Export -->
        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Export / Import Library</h2>
            <span class="text-[0.65rem] text-slate-400">Use this to back up or move to another device.</span>
          </div>
          <textarea id="json-area" rows="5"
                    class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-[0.7rem] font-mono focus:outline-none focus:ring-2 focus:ring-emerald-500/70"
                    placeholder="Click Export to see JSON for your current material library."></textarea>
          <div class="flex justify-end gap-2">
            <button id="export-json"
                    class="text-xs px-3 py-1 rounded-full border border-slate-700 bg-slate-900/80 hover:bg-slate-800/90">
              Export
            </button>
            <button id="import-json"
                    class="text-xs px-3 py-1 rounded-full bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400">
              Import (Overwrite)
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // Bump the storage key so this version loads fresh MBPS defaults
    const STORAGE_KEY = 'mbpsMaterialLibraryV2';

    let materialLibrary = [];
    let calcLines = [];

    // DOM elements
    const matNameEl = document.getElementById('mat-name');
    const matCategoryEl = document.getElementById('mat-category');
    const matUnitEl = document.getElementById('mat-unit');
    const matCostMaterialEl = document.getElementById('mat-cost-material');
    const matCostLaborEl = document.getElementById('mat-cost-labor');
    const matActiveEl = document.getElementById('mat-active');
    const editIdEl = document.getElementById('edit-id');

    const libraryListEl = document.getElementById('library-list');
    const resetLibraryBtn = document.getElementById('reset-library');
    const saveMaterialBtn = document.getElementById('save-material');
    const clearFormBtn = document.getElementById('clear-form');

    const calcMaterialEl = document.getElementById('calc-material');
    const calcQtyEl = document.getElementById('calc-qty');
    const addLineBtn = document.getElementById('add-line');
    const calcBodyEl = document.getElementById('calc-body');
    const totalMatEl = document.getElementById('total-mat');
    const totalLaborEl = document.getElementById('total-labor');
    const grandTotalEl = document.getElementById('grand-total');

    const jsonAreaEl = document.getElementById('json-area');
    const exportJsonBtn = document.getElementById('export-json');
    const importJsonBtn = document.getElementById('import-json');

    // ---- Default MBPS Library (Locked Core Items) ----
    function getDefaultLibrary() {
      return [
        {
          id: crypto.randomUUID(),
          name: 'LVP Flooring',
          category: 'Flooring',
          unit: 'sqft',
          materialCost: 5.00,
          laborCost: 3.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Interior Paint',
          category: 'Interior',
          unit: 'sqft',
          materialCost: 0.95,
          laborCost: 1.85,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Window Replacement',
          category: 'Exterior',
          unit: 'each',
          materialCost: 550.00,
          laborCost: 150.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Roof',
          category: 'Roof',
          unit: 'sqft',
          materialCost: 5.00,
          laborCost: 3.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Kitchen Cabinets',
          category: 'Kitchen',
          unit: 'lf',
          materialCost: 300.00,
          laborCost: 75.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Full Electrical Upgrade',
          category: 'Electrical',
          unit: 'sqft',
          materialCost: 4.00,
          laborCost: 6.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Full Kitchen Upgrade Low End',
          category: 'Full Kitchen',
          unit: 'sqft',
          materialCost: 75.00,
          laborCost: 65.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Full Kitchen Upgrade Mid-Range',
          category: 'Kitchen',
          unit: 'sqft',
          materialCost: 150.00,
          laborCost: 115.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Full Kitchen Upgrade High End',
          category: 'Kitchen',
          unit: 'sqft',
          materialCost: 225.00,
          laborCost: 150.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Plumbing Upgrade',
          category: 'Plumbing',
          unit: 'sqft',
          materialCost: 4.25,
          laborCost: 5.75,
          active: true,
          core: true
        },

       // ðŸš¿ BATHROOM â€“ $/SQFT (full upgrade)
    {
      id: crypto.randomUUID(),
      name: 'Full Bathroom Upgrade Low End',
      category: 'Bathroom',
      unit: 'sqft',
      // e.g. 40 sqft x (125+100) = $9,000
      materialCost: 125.00,
      laborCost: 100.00,
      active: true,
      core: true
    },
    {
      id: crypto.randomUUID(),
      name: 'Full Bathroom Upgrade Mid-Range',
      category: 'Bathroom',
      unit: 'sqft',
      // e.g. 40 sqft x (175+150) = $13,000
      materialCost: 175.00,
      laborCost: 150.00,
      active: true,
      core: true
    },
    {
      id: crypto.randomUUID(),
      name: 'Full Bathroom Upgrade High End',
      category: 'Bathroom',
      unit: 'sqft',
      // e.g. 40 sqft x (250+200) = $18,000
      materialCost: 250.00,
      laborCost: 200.00,
      active: true,
      core: true
    },
   
        {
          id: crypto.randomUUID(),
          name: 'Fence',
          category: 'Fence',
          unit: 'lf',
          materialCost: 13.00,
          laborCost: 12.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Vinyl Siding',
          category: 'Exterior',
          unit: 'sqft',
          materialCost: 4.25,
          laborCost: 3.25,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Deck',
          category: 'Deck',
          unit: 'sqft',
          materialCost: 20.00,
          laborCost: 22.00,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Exterior Paint',
          category: 'Exterior',
          unit: 'sqft',
          materialCost: 0.80,
          laborCost: 1.70,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Carpet',
          category: 'Carpet',
          unit: 'sqft',
          materialCost: 1.75,
          laborCost: 1.25,
          active: true,
          core: true
        },
        {
          id: crypto.randomUUID(),
          name: 'Tile',
          category: 'Tile',
          unit: 'sqft',
          materialCost: 5.50,
          laborCost: 6.50,
          active: true,
          core: true
        }
      ];
    }

    function isCoreItem(itemId) {
      const item = materialLibrary.find(m => m.id === itemId);
      return !!(item && item.core);
    }

    // ---- Storage helpers ----
    function loadLibrary() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          materialLibrary = getDefaultLibrary();
        } else {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length) {
            materialLibrary = parsed.map(item => ({
              id: item.id || crypto.randomUUID(),
              name: item.name || 'Unnamed',
              category: item.category || '',
              unit: item.unit || 'sqft',
              materialCost: Number(item.materialCost || 0),
              laborCost: Number(item.laborCost || 0),
              active: item.active !== false,
              core: item.core === true // preserve core flag if present
            }));
          } else {
            materialLibrary = getDefaultLibrary();
          }
        }
      } catch (e) {
        console.error('Failed to load library', e);
        materialLibrary = getDefaultLibrary();
      }
      renderLibrary();
      renderCalcMaterialOptions();
    }

    function saveLibrary() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(materialLibrary));
      renderLibrary();
      renderCalcMaterialOptions();
    }

    // ---- Library UI ----
    function renderLibrary() {
      libraryListEl.innerHTML = '';
      if (!materialLibrary.length) {
        libraryListEl.innerHTML =
          '<p class="text-xs text-slate-400 italic">No materials yet. Add some above.</p>';
        return;
      }

      materialLibrary.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-slate-950/80 border border-slate-800 rounded-xl p-3 flex justify-between gap-2 text-xs';

        const statusBadge = `
          <span class="inline-flex items-center px-2 py-0.5 rounded-full ${
            item.active
              ? 'bg-emerald-500/10 text-emerald-300 border border-emerald-500/40'
              : 'bg-slate-700/60 text-slate-300 border border-slate-600'
          }">
            ${item.active ? 'Active' : 'Inactive'}
          </span>
          ${item.core ? '<span class="ml-1 inline-flex items-center px-2 py-0.5 rounded-full bg-sky-500/10 text-sky-300 border border-sky-500/40">Core</span>' : ''}
        `;

        const actionsHtml = item.core
          ? `<span class="text-[0.65rem] text-slate-500">Core item</span>`
          : `
            <button data-id="${item.id}" class="edit-btn text-[0.65rem] px-2 py-1 rounded-full border border-slate-700 hover:bg-slate-800/90">
              Edit
            </button>
            <button data-id="${item.id}" class="delete-btn text-[0.65rem] px-2 py-1 rounded-full border border-red-500/60 text-red-300 hover:bg-red-500/10">
              Delete
            </button>
          `;

        card.innerHTML = `
          <div class="space-y-0.5">
            <div class="font-semibold text-slate-100">${item.name}</div>
            <div class="text-slate-400">
              ${item.category || 'Uncategorized'} Â· Unit: ${item.unit}
            </div>
            <div class="text-slate-400">
              Material: $${item.materialCost.toFixed(2)} / ${item.unit} Â· Labor: $${item.laborCost.toFixed(2)} / ${item.unit}
            </div>
            <div class="text-[0.65rem] mt-0.5">
              ${statusBadge}
            </div>
          </div>
          <div class="flex flex-col items-end justify-between gap-1">
            ${actionsHtml}
          </div>
        `;

        libraryListEl.appendChild(card);
      });

      // Wire up buttons (core items won't have these)
      libraryListEl.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => startEdit(btn.dataset.id));
      });
      libraryListEl.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteMaterial(btn.dataset.id));
      });
    }

    function clearForm() {
      matNameEl.value = '';
      matCategoryEl.value = '';
      matUnitEl.value = 'sqft';
      matCostMaterialEl.value = '';
      matCostLaborEl.value = '';
      matActiveEl.value = 'true';
      editIdEl.value = '';
      saveMaterialBtn.textContent = 'Add to Library';
    }

    function startEdit(id) {
      if (isCoreItem(id)) {
        alert('Core MBPS items are locked. Add a new custom item instead.');
        return;
      }
      const item = materialLibrary.find(m => m.id === id);
      if (!item) return;
      matNameEl.value = item.name;
      matCategoryEl.value = item.category;
      matUnitEl.value = item.unit;
      matCostMaterialEl.value = item.materialCost;
      matCostLaborEl.value = item.laborCost;
      matActiveEl.value = item.active ? 'true' : 'false';
      editIdEl.value = item.id;
      saveMaterialBtn.textContent = 'Update Material';
    }

    function deleteMaterial(id) {
      if (isCoreItem(id)) {
        alert('Core MBPS items cannot be deleted.');
        return;
      }
      if (!confirm('Delete this material?')) return;
      materialLibrary = materialLibrary.filter(m => m.id !== id);
      saveLibrary();
      // Also remove from any calc lines
      calcLines = calcLines.filter(line => line.materialId !== id);
      renderCalcLines();
    }

    saveMaterialBtn.addEventListener('click', () => {
      const name = matNameEl.value.trim();
      if (!name) {
        alert('Material name is required.');
        return;
      }
      const materialCost = parseFloat(matCostMaterialEl.value || '0');
      const laborCost = parseFloat(matCostLaborEl.value || '0');

      const data = {
        name,
        category: matCategoryEl.value.trim(),
        unit: matUnitEl.value,
        materialCost: isNaN(materialCost) ? 0 : materialCost,
        laborCost: isNaN(laborCost) ? 0 : laborCost,
        active: matActiveEl.value === 'true'
      };

      const existingId = editIdEl.value;
      if (existingId) {
        if (isCoreItem(existingId)) {
          alert('Core MBPS items are locked. Add a new custom item instead.');
        } else {
          const idx = materialLibrary.findIndex(m => m.id === existingId);
          if (idx >= 0) {
            materialLibrary[idx] = { ...materialLibrary[idx], ...data };
          }
        }
      } else {
        materialLibrary.push({
          id: crypto.randomUUID(),
          ...data,
          core: false
        });
      }

      saveLibrary();
      clearForm();
    });

    clearFormBtn.addEventListener('click', clearForm);

    resetLibraryBtn.addEventListener('click', () => {
      if (!confirm('This will reset to the MBPS default cost library and clear any custom items. Continue?')) return;
      materialLibrary = getDefaultLibrary();
      saveLibrary();
      clearForm();
      calcLines = [];
      renderCalcLines();
    });

    // ---- Calculator ----
    function renderCalcMaterialOptions() {
      calcMaterialEl.innerHTML = '';
      const activeItems = materialLibrary.filter(m => m.active);
      if (!activeItems.length) {
        calcMaterialEl.innerHTML = '<option value="">No active materials</option>';
        return;
      }
      activeItems.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        opt.textContent = `${item.name} (${item.unit})`;
        calcMaterialEl.appendChild(opt);
      });
    }

    addLineBtn.addEventListener('click', () => {
      const materialId = calcMaterialEl.value;
      const qty = parseFloat(calcQtyEl.value || '0');
      if (!materialId || !qty || qty <= 0) {
        alert('Select a material and enter a quantity.');
        return;
      }
      const material = materialLibrary.find(m => m.id === materialId);
      if (!material) return;

      const line = {
        id: crypto.randomUUID(),
        materialId,
        name: material.name,
        unit: material.unit,
        qty,
        materialCost: material.materialCost,
        laborCost: material.laborCost
      };
      calcLines.push(line);
      calcQtyEl.value = '';
      renderCalcLines();
    });

    function renderCalcLines() {
      calcBodyEl.innerHTML = '';
      let totalMat = 0;
      let totalLabor = 0;

      calcLines.forEach(line => {
        const matTotal = line.materialCost * line.qty;
        const labTotal = line.laborCost * line.qty;
        totalMat += matTotal;
        totalLabor += labTotal;

        const tr = document.createElement('tr');
        tr.className = 'bg-slate-950/80';

        tr.innerHTML = `
          <td class="px-2 py-1 text-[0.7rem]">${line.name} <span class="text-slate-500">(${line.unit})</span></td>
          <td class="px-2 py-1 text-right text-[0.7rem]">${line.qty}</td>
          <td class="px-2 py-1 text-right text-[0.7rem]">$${line.materialCost.toFixed(2)}</td>
          <td class="px-2 py-1 text-right text-[0.7rem]">$${line.laborCost.toFixed(2)}</td>
          <td class="px-2 py-1 text-right text-[0.7rem]">$${(matTotal + labTotal).toFixed(2)}</td>
          <td class="px-2 py-1 text-right">
            <button data-id="${line.id}" class="remove-line text-[0.65rem] text-red-400 hover:text-red-300">Remove</button>
          </td>
        `;
        calcBodyEl.appendChild(tr);
      });

      calcBodyEl.querySelectorAll('.remove-line').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          calcLines = calcLines.filter(l => l.id !== id);
          renderCalcLines();
        });
      });

      totalMatEl.textContent = '$' + totalMat.toFixed(2);
      totalLaborEl.textContent = '$' + totalLabor.toFixed(2);
      grandTotalEl.textContent = '$' + (totalMat + totalLabor).toFixed(2);
    }

    // ---- Import / Export ----
    exportJsonBtn.addEventListener('click', () => {
      const json = JSON.stringify(materialLibrary, null, 2);
      jsonAreaEl.value = json;
      try {
        navigator.clipboard.writeText(json);
      } catch {}
    });

    importJsonBtn.addEventListener('click', () => {
      if (!jsonAreaEl.value.trim()) {
        alert('Paste JSON into the box first.');
        return;
      }
      try {
        const parsed = JSON.parse(jsonAreaEl.value);
        if (!Array.isArray(parsed)) throw new Error('JSON must be an array');
        materialLibrary = parsed.map(item => ({
          id: item.id || crypto.randomUUID(),
          name: item.name || 'Unnamed',
          category: item.category || '',
          unit: item.unit || 'sqft',
          materialCost: Number(item.materialCost || 0),
          laborCost: Number(item.laborCost || 0),
          active: item.active !== false,
          core: item.core === true
        }));
        saveLibrary();
        calcLines = [];
        renderCalcLines();
        alert('Library imported.');
      } catch (e) {
        console.error(e);
        alert('Invalid JSON. Import failed.');
      }
    });

    // Init
    loadLibrary();
  </script>

  <!-- Service Worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('./sw.js')
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
